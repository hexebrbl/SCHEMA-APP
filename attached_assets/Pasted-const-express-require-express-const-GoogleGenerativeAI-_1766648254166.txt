const express = require('express');
const { GoogleGenerativeAI } = require('@google/generative-ai');
const path = require('path');

const app = express();
const port = 3000;

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);

app.use(express.static('public'));
app.use(express.json());

app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.post('/generate', async (req, res) => {
  try {
    const { keyword, filters } = req.body;
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    // ★プロンプトエンジニアリング: 文脈に応じた書き分け指示
    const prompt = `
      あなたはプロの「メディア・キュレーター」です。
      ユーザーの検索キーワード: "${keyword}"
      
      【フィルター条件】
      - 媒体カテゴリー: ${filters.media} (※「書籍」には小説・画集・写真集が含まれます。「映画・映像」には映画・ドラマ・MVが含まれます)
      - 年代・雰囲気: ${filters.era}
      - 深度: ${filters.depth}

      【選定の鉄則（重要）】
      キーワードの性質と、媒体の性質が矛盾しないように作品を選んでください。

      1. **キーワードが「物語・ストーリー」を求めている場合**
         (例: "どんでん返し", "泣ける", "ミステリー", "伏線", "結末")
         → **絶対に「画集」「写真集」「MV」「サントラ」を選ばないでください。**
         → 必ず「小説」「漫画」「映画」「ドラマ」など、明確なストーリーがあるものを選んでください。

      2. **キーワードが「雰囲気・ビジュアル」を求めている場合**
         (例: "退廃的", "サイバーパンク", "美しい", "色彩", "癒やし")
         → 「画集」「写真集」「MV」「映像美のある映画」を優先的に提案してください。

      【解説（reason）の書き方】
      選んだ作品の「媒体」に合わせて、解説の視点を変えてください。

      - **小説・映画・漫画の場合**:
        物語の構成や、テーマの深さを解説してください。
      
      - **画集・写真集・MVの場合**:
        「あらすじ」は絶対に捏造しないでください。
        代わりに「視覚的なトーン」「色彩」「構図」「空気感」「イマジネーションの源泉としての魅力」を解説してください。

      【出力フォーマット】
      以下のJSON形式のみを出力してください（Markdown記法は不要）：
      {
        "ideas": [
          {
            "title": "作品名",
            "category": "正確な媒体名（例: 画集、SF小説、MV）",
            "reason": "媒体に合わせた魅力の解説（100文字程度）"
          }
        ]
      }
    `;

    const result = await model.generateContent(prompt);
    const responseText = result.response.text();

    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error("AI output format error");
    }

    const jsonData = JSON.parse(jsonMatch[0]);
    res.json(jsonData);

  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to generate ideas' });
  }
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});
